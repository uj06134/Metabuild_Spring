<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/mylayout}">
<head>
    <meta charset="UTF-8">
    <title>영화 목록 페이지</title>

    <th:block layout:fragment="script">
        <script th:inline="javascript">
            // 전체 선택 / 해제
            function allCheck() {
                const allChecked = document.getElementById("all").checked;
                const rowChecks = document.getElementsByName("row");

                for (let i = 0; i < rowChecks.length; i++) {
                    rowChecks[i].checked = allChecked;
                }
            }

            // 선택 항목 삭제
            function checkDelete() {
                const rowChecks = document.getElementsByName("row");
                let hasChecked = false;

                for (let i = 0; i < rowChecks.length; i++) {
                    if (rowChecks[i].checked) {
                        hasChecked = true;
                        break;
                    }
                }

                if (!hasChecked) {
                    alert('삭제할 영화를 한 개 이상 선택하세요.');
                    return;
                }

                if (confirm('정말 삭제하시겠습니까?')) {
                    document.myform.submit();
                } else {
                    alert('삭제 작업이 취소되었습니다.');
                }
            }
        </script>
    </th:block>
</head>

<body>
<div class="content" layout:fragment="content">
    <h2>영화 목록</h2>

    <!-- 검색창 -->
    <form th:action="@{/mlist}" method="get"
          class="d-flex justify-content-end align-items-center mb-3 gap-2">
        <input type="text" name="keyword" th:value="${keyword}"
               class="form-control w-auto" placeholder="이름 또는 장르 입력"
               style="min-width: 250px;">
        <button type="submit" class="btn btn-primary">검색</button>
    </form>

    <!-- 영화 목록 테이블 -->
    <form name="myform" action="/movie/checkDelete" method="post">
        <table class="table table-hover text-center align-middle">
            <thead class="table-light">
            <tr>
                <th><input type="checkbox" id="all" onclick="allCheck()"> 번호</th>
                <th>아이디</th>
                <th>이름</th>
                <th>나이</th>
                <th>좋아하는 장르</th>
                <th>즐겨보는 시간대</th>
                <th>동반 관객수</th>
                <th>개선사항</th>
                <th>수정</th>
                <th>삭제</th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="movie : ${movieList}">
                <td>
                    <input type="checkbox" name="row" th:value="${movie.num}">
                    <label th:text="${movie.num}"></label>
                </td>
                <td th:text="${movie.id}"></td>
                <td>
                    <a th:href="@{/movie/detail(num=${movie.num}, page=${page}, size=${size}, keyword=${keyword})}"
                       th:text="${movie.name}" style="text-decoration: none;"></a>
                </td>
                <td th:text="${movie.age}"></td>
                <td th:text="${movie.genre}"></td>
                <td th:text="${movie.time}"></td>
                <td th:text="${movie.partner}"></td>
                <td th:text="${movie.memo}"></td>
                <td>
                    <a th:href="@{/movie/update(num=${movie.num}, page=${page}, size=${size}, keyword=${keyword})}">
                        수정
                    </a>
                </td>
                <td>
                    <a th:href="@{/movie/delete(num=${movie.num}, page=${page}, size=${size}, keyword=${keyword})}"
                       onclick="return confirm('정말 삭제하시겠습니까?');">삭제</a>
                </td>
            </tr>
            </tbody>
        </table>

        <!-- 버튼 영역 -->
        <div class="text-center mt-3">
            <button type="button" class="btn btn-primary"
                    th:onclick="|location.href='@{/movie/insert}'|">
                추가
            </button>
            <button type="button" class="btn btn-danger" onclick="checkDelete()">
                선택항목 삭제
            </button>
        </div>
    </form>

    <br>

    <!-- 페이지네이션 -->
    <div th:if="${movieList.totalPages > 0}">
        <nav>
            <ul class="pagination justify-content-center">
                <li class="page-item" th:classappend="${movieList.hasPrevious()}?'':'disabled'">
                    <a class="page-link"
                       th:href="@{/mlist(page=${movieList.number-1}, size=${movieList.size}, keyword=${keyword})}">
                        이전
                    </a>
                </li>

                <li class="page-item"
                    th:each="i : ${#numbers.sequence(0, movieList.totalPages-1)}"
                    th:classappend="${i==movieList.number}?'active':''">
                    <a class="page-link"
                       th:href="@{/mlist(page=${i}, size=${movieList.size}, keyword=${keyword})}"
                       th:text="${i+1}"></a>
                </li>

                <li class="page-item" th:classappend="${movieList.hasNext()}?'':'disabled'">
                    <a class="page-link"
                       th:href="@{/mlist(page=${movieList.number+1}, size=${movieList.size}, keyword=${keyword})}">
                        다음
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>
</body>
</html>
